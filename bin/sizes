#!/usr/bin/env ruby
#
# Collects commit files_touched data for a git repo
# Produces a JSON object of the form
#
# [
#   {
#      author: Someone's name,
#      commits: [
#        { date: 2014-05-12, files_touched: 2 },
#        { date: 2014-05-13, files_touched: 4 }
#      ]
#   },
#   ...
# ]
#

require 'json'

def commits_by_author
  raw_log = `git log --pretty="%h/%aN/%ci" --shortstat`
  lines = raw_log.split("\n")

  logs = []
  (0..(lines.length-1)).each do |i|
    if lines[i].empty?
      logs << "#{lines[i-1]}/#{lines[i+1]}"
    end
  end

  commits = Hash.new { |h,k| h[k] = Array.new }
  logs.each do |a|
    ref, author, date, count = a.split('/')
    num_files_touched = count.to_i
    commits[author] << {
      ref: ref,
      author: author,
      date: date,
      num_files_touched: num_files_touched
    }
  end
  commits
end

data = commits_by_author.map do |author, commits|
  { author: author, commits: commits }
end

$stdout.puts data.to_json
