#!/usr/bin/env ruby
#
# Collects commit size data for a git repo
# Produces a JSON object of the form
#
# [
#   {
#      author: Someone's name,
#      commits: [
#        { date: 2014-05-12, size: 2 },
#        { date: 2014-05-13, size: 4 }
#      ]
#   },
#   ...
# ]
#

require 'json'

raw_log = `git log --pretty="%aN/%ci" --shortstat`
commits = Hash.new { |h,k| h[k] = Array.new }
lines = raw_log.split("\n")

logs = []
(0..(lines.length-1)).each do |i|
  if lines[i].empty?
    logs << "#{lines[i-1]}/#{lines[i+1]}"
  end
end

logs.each do |a|
  author, date, count = a.split('/')
  size = count.to_i
  commits[author] << { date: date, size: size }
end

data = []
commits.each do |author, commits|
  data << { author: author, commits: commits }
end

$stdout.puts data.to_json
