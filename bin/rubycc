#!/usr/bin/env ruby
#
# Collects the complexity metrics for a single ruby source file
#
# Usage: $0 filepath
#

require 'json'
require 'ruby_parser'

require_relative '../lib/ruby/ruby_source_file'

#- - - Helpers - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

def complexity_report(path)
  report = RubySourceFile.new(path).complexity
  efferent_multiplier = report[:num_dependencies] + 1
  branches = 1 + report[:num_branches]
  report[:weight] = branches * efferent_multiplier
  report
end

if ARGV.length != 1
  $stderr.puts "Usage: #{File.basename($0)} filepath"
  exit 1
end

puts JSON.pretty_generate complexity_report(ARGV[0])
exit 0
